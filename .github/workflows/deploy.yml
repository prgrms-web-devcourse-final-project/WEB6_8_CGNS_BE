dname: deploy.yml

env:
  IMAGE_REPOSITORY: team11 # GHCR Ïù¥ÎØ∏ÏßÄ Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨Î™Ö(ÏÜåÏú†Ïûê Ìè¨Ìï® X)
  CONTAINER_1_NAME: team11_1 # Ïä¨Î°Ø1(Í≥†Ï†ï Ïù¥Î¶Ñ)
  CONTAINER_2_NAME: team11_2 # Ïä¨Î°Ø2(Í≥†Ï†ï Ïù¥Î¶Ñ)
  CONTAINER_PORT: 8080 # Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂Ä Ìè¨Ìä∏(Ïä§ÌîÑÎßÅÎ∂ÄÌä∏)
  EC2_INSTANCE_TAG_NAME: team11-terra-ec2-1 # Î∞∞Ìè¨ ÎåÄÏÉÅ EC2 Name ÌÉúÍ∑∏
  DOCKER_NETWORK: common # ÎèÑÏª§ ÎÑ§Ìä∏ÏõåÌÅ¨
  BACKEND_DIR: . # Dockerfile ÏúÑÏπò

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }} # Ïª§Î∞ãÏù¥ ÏßßÏùÄ ÏãúÍ∞ÑÏïàÏóê Î™∞Î†§ÎèÑ ÏµúÏã† Ïª§Î∞ãÏóê ÎåÄÌï¥ÏÑúÎßå Ïï°ÏÖòÏù¥ ÏàòÌñâÎêòÎèÑÎ°ù
  cancel-in-progress: false # Í∏∞Ï°¥Ïóê ÏãúÏûëÎêú ÏûëÏóÖÏùÄ ÏÉà Ïª§Î∞ãÏù¥ Îì§Ïñ¥ÏôîÎã§Í≥† Ìï¥ÏÑú Î∞îÎ°ú ÎÅÑÏßÄ ÏïäÍ≥† ÎÅùÎÇ†ÎïåÍπåÏßÄ ÎåÄÍ∏∞

on:
  push:
    paths:
      - ".github/workflows/**"
      - ".env"
      - "src/**"
      - "build.gradle.kts"
      - "settings.gradle.kts"
      - "Dockerfile"
    branches:
      - main
permissions:
  contents: write # ÌÉúÍ∑∏/Î¶¥Î¶¨Ï¶à
  packages: write # GHCR Ìë∏Ïãú

# Í∏∞Î≥∏ ÏÖ∏
defaults:
  run:
    shell: bash

jobs:
  makeTagAndRelease:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.create_tag.outputs.new_tag }} # Ïù¥ÌõÑ Ïû°ÏóêÏÑú ÏÇ¨Ïö©Ìï† ÌÉúÍ∑∏Î™Ö
    steps:
      - uses: actions/checkout@v4

      # Î≤ÑÏ†Ñ ÌÉúÍ∑∏ ÏûêÎèô ÏÉùÏÑ± (vX.Y.Z)
      - name: Create Tag
        id: create_tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # Î¶¥Î¶¨Ï¶à ÏÉùÏÑ±
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.create_tag.outputs.new_tag }}
          release_name: Release ${{ steps.create_tag.outputs.new_tag }}
          body: ${{ steps.create_tag.outputs.changelog }}
          draft: false
          prerelease: false

  # ---------------------------------------------------------
  # 2) ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄ ÎπåÎìú/Ìë∏Ïãú (Ï∫êÏãú ÏµúÎåÄ ÌôúÏö©)
  # ---------------------------------------------------------
  buildImageAndPush:
    name: ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄ ÎπåÎìúÏôÄ Ìë∏Ïãú
    needs: makeTagAndRelease
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v4

        # ÎπåÎìú Ïª®ÌÖçÏä§Ìä∏Ïóê .env ÏÉùÏÑ± (ÎπÑÏñ¥ÏûàÏñ¥ÎèÑ Ïã§Ìå®ÌïòÏßÄ ÏïäÍ≤å)
        - name: .env ÌååÏùº ÏÉùÏÑ±
          env:
            DOT_ENV: ${{ secrets.DOT_ENV }}
          run: |
            # .envÍ∞Ä ÏóÜÏúºÎ©¥ ÎπåÎìú Ï∫êÏãúÍ∞Ä Îß§Î≤à Íπ®Ïßà Ïàò ÏûàÏúºÎØÄÎ°ú Ìï≠ÏÉÅ ÏÉùÏÑ±
            mkdir -p "${{ env.BACKEND_DIR }}"
            printf "%s" "${DOT_ENV}" > "${{ env.BACKEND_DIR }}/.env"

        - name: Docker Buildx ÏÑ§Ïπò
          uses: docker/setup-buildx-action@v3

        # GHCR Î°úÍ∑∏Ïù∏
        - name: Î†àÏßÄÏä§Ìä∏Î¶¨ Î°úÍ∑∏Ïù∏
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        # Ï†ÄÏû•ÏÜå ÏÜåÏú†ÏûêÎ™ÖÏùÑ ÏÜåÎ¨∏ÏûêÎ°ú (GHCR Í≤ΩÎ°ú ÌëúÏ§ÄÌôî)
        - name: set lower case owner name
          run: |
            echo "OWNER_LC=${OWNER,,}" >> "${GITHUB_ENV}"
          env:
            OWNER: "${{ github.repository_owner }}"

        # Ï∫êÏãúÎ•º ÏµúÎåÄÌïú ÌôúÏö©ÌïòÏó¨ ÎπåÎìú ‚Üí Î≤ÑÏ†ÑÌÉúÍ∑∏ Î∞è latest ÎèôÏãú Ìë∏Ïãú
        - name: ÎπåÎìú Ïï§ Ìë∏Ïãú
          uses: docker/build-push-action@v6
          with:
            context: ${{ env.BACKEND_DIR }}
            push: true
            cache-from: type=gha
            cache-to: type=gha,mode=max
            tags: |
              ghcr.io/${{ env.OWNER_LC }}/${{ env.IMAGE_REPOSITORY }}:${{ needs.makeTagAndRelease.outputs.tag_name }}
              ghcr.io/${{ env.OWNER_LC }}/${{ env.IMAGE_REPOSITORY }}:latest

  # ---------------------------------------------------------
  # 3) Blue/Green Î¨¥Ï§ëÎã® Î∞∞Ìè¨ (EC2 + NPM Ïä§ÏúÑÏπò)
  # ---------------------------------------------------------
  deploy:
    name: Blue/Green Î¨¥Ï§ëÎã® Î∞∞Ìè¨
    runs-on: ubuntu-latest
    needs: [ makeTagAndRelease, buildImageAndPush ]
    steps:
        # AWS ÏûêÍ≤© Íµ¨ÏÑ±
        - uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-region: ${{ secrets.AWS_REGION }}
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

        # Name ÌÉúÍ∑∏Î°ú EC2 Ïù∏Ïä§ÌÑ¥Ïä§ Ï°∞Ìöå (ÏóÜÏúºÎ©¥ Ïã§Ìå®)
        - name: Ïù∏Ïä§ÌÑ¥Ïä§ ID Í∞ÄÏ†∏Ïò§Í∏∞
          id: get_instance_id
          run: |
            INSTANCE_ID=$(aws ec2 describe-instances \
              --filters "Name=tag:Name,Values=${{ env.EC2_INSTANCE_TAG_NAME }}" "Name=instance-state-name,Values=running" \
              --query "Reservations[].Instances[].InstanceId" --output text)
            [[ -n "${INSTANCE_ID}" && "${INSTANCE_ID}" != "None" ]] || { echo "No running instance found"; exit 1; }
            echo "INSTANCE_ID=${INSTANCE_ID}" >> "${GITHUB_ENV}"

        # ÏõêÍ≤©(SSM)ÏúºÎ°ú Blue/Green Ïä§ÏúÑÏπò ÏàòÌñâ
        - name: AWS SSM Send-Command
          uses: peterkimzz/aws-ssm-send-command@master
          with:
            aws-region: ${{ secrets.AWS_REGION }}
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            instance-ids: ${{ env.INSTANCE_ID }}
            working-directory: /
            comment: Deploy
            command: |
              set -Eeuo pipefail

              # ---------------------------------------------------------
              # 0) Ïã§Ìñâ Î°úÍ∑∏(ÎùºÏù∏ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Î∂ÄÏ∞©)
              # ---------------------------------------------------------
              LOG="/tmp/ssm-$(date +%Y%m%d_%H%M%S).log"
              exec > >(awk '{ fflush(); print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }' | tee -a "$LOG")
              exec 2> >(awk '{ fflush(); print strftime("[%Y-%m-%d %H:%M:%S]"), $0 }' | tee -a "$LOG" >&2)

              # ---------------------------------------------------------
              # 1) Î≥ÄÏàò Ï†ïÏùò
              #    - Ïä¨Î°Ø Ïù¥Î¶ÑÏùÄ Í≥†Ï†ï(Îëê Í∞úÏùò Ïª®ÌÖåÏù¥ÎÑà Ïù¥Î¶Ñ)
              #    - blue/greenÏùÄ "Ïó≠Ìï†"Ïù¥Î©∞ Îß§ Î∞∞Ìè¨ÎßàÎã§ Î∞îÎÄú
              # ---------------------------------------------------------
              source /etc/environment || true   # ÏãúÏä§ÌÖú Ï†ÑÏó≠ Î≥ÄÏàò(+ ÎπÑÎ∞Ä) Ï£ºÏûÖ ÏãúÎèÑ
              OWNER_LC="${{ github.repository_owner }}"
              OWNER_LC="${OWNER_LC,,}"                                # ÏÜåÎ¨∏Ïûê ÌëúÏ§ÄÌôî
              IMAGE_TAG="${{ needs.makeTagAndRelease.outputs.tag_name }}"
              IMAGE_REPOSITORY="${{ env.IMAGE_REPOSITORY }}"
              IMAGE="ghcr.io/${OWNER_LC}/${IMAGE_REPOSITORY}:${IMAGE_TAG}"
              SLOT1="${{ env.CONTAINER_1_NAME }}"
              SLOT2="${{ env.CONTAINER_2_NAME }}"
              PORT_IN="${{ env.CONTAINER_PORT }}"
              NET="${{ env.DOCKER_NETWORK }}"

              echo "üîπ Use image: ${IMAGE}"
              docker pull "${IMAGE}"

              # ---------------------------------------------------------
              # 2) Nginx Proxy Manager(NPM) API ÌÜ†ÌÅ∞ Î∞úÍ∏â
              #     - /etc/environment Îì±Ïóê ÏÑ§Ï†ïÎêú PASSWORD_1, APP_1_DOMAIN ÏÇ¨Ïö© Í∞ÄÏ†ï
              # ---------------------------------------------------------
              TOKEN=$(curl -s -X POST http://127.0.0.1:81/api/tokens \
                -H "Content-Type: application/json" \
                -d "{\"identity\": \"admin@npm.com\", \"secret\": \"${PASSWORD_1:-}\"}" | jq -r '.token')

              # ÌÜ†ÌÅ∞/ÎèÑÎ©îÏù∏ Í≤ÄÏ¶ù(ÏóÜÏúºÎ©¥ Ïã§Ìå®)
              [[ -n "${TOKEN}" && "${TOKEN}" != "null" ]] || { echo "NPM token issue failed"; exit 1; }
              [[ -n "${APP_1_DOMAIN:-}" ]] || { echo "APP_1_DOMAIN is empty"; exit 1; }

              # ÎåÄÏÉÅ ÌîÑÎ°ùÏãú Ìò∏Ïä§Ìä∏ ID Ï°∞Ìöå(ÎèÑÎ©îÏù∏ Îß§Ïπ≠)
              PROXY_ID=$(curl -s -X GET "http://127.0.0.1:81/api/nginx/proxy-hosts" \
                -H "Authorization: Bearer ${TOKEN}" \
                | jq ".[] | select(.domain_names[]==\"${APP_1_DOMAIN}\") | .id")

              [[ -n "${PROXY_ID}" && "${PROXY_ID}" != "null" ]] || { echo "Proxy host not found for ${APP_1_DOMAIN}"; exit 1; }

              # ÌòÑÏû¨ ÌîÑÎ°ùÏãúÍ∞Ä Î∞îÎùºÎ≥¥Îäî ÏóÖÏä§Ìä∏Î¶º(Ïª®ÌÖåÏù¥ÎÑàÎ™Ö) Ï°∞Ìöå
              CURRENT_HOST=$(curl -s -X GET "http://127.0.0.1:81/api/nginx/proxy-hosts/${PROXY_ID}" \
                -H "Authorization: Bearer ${TOKEN}" \
                | jq -r '.forward_host')

              echo "üîé CURRENT_HOST: ${CURRENT_HOST:-none}"

              # ---------------------------------------------------------
              # 3) Ïó≠Ìï†(blue/green) ÌåêÏ†ï
              #    - blue : ÌòÑÏû¨ Ïö¥ÏòÅ Ï§ë(CURRENT_HOST)
              #    - green: Îã§Ïùå Ïö¥ÏòÅ(ÍµêÏ≤¥ ÎåÄÏÉÅ)
              # ---------------------------------------------------------
              if [[ "${CURRENT_HOST:-}" == "${SLOT1}" ]]; then
                BLUE="${SLOT1}"
                GREEN="${SLOT2}"
              elif [[ "${CURRENT_HOST:-}" == "${SLOT2}" ]]; then
                BLUE="${SLOT2}"
                GREEN="${SLOT1}"
              else
                BLUE="none"   # Ï¥àÍ∏∞ Î∞∞Ìè¨
                GREEN="${SLOT1}"
              fi
              echo "üé® role -> blue(now): ${BLUE}, green(next): ${GREEN}"

              # ---------------------------------------------------------
              # 4) green Ïó≠Ìï† Ïª®ÌÖåÏù¥ÎÑà Ïû¨Í∏∞Îèô
              #    - Í∞ôÏùÄ ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÏóêÏÑú NPMÏù¥ Ïª®ÌÖåÏù¥ÎÑàÎ™Ö:PORTÎ°ú ÌîÑÎ°ùÏãúÌïòÎØÄÎ°ú -p Î∂àÌïÑÏöî
              # ---------------------------------------------------------
              docker rm -f "${GREEN}" >/dev/null 2>&1 || true
              echo "üöÄ run new container ‚Üí ${GREEN}"
              docker run -d --name "${GREEN}" \
                --restart unless-stopped \
                --network "${NET}" \
                -e TZ=Asia/Seoul \
                -e SPRING_PROFILES_ACTIVE=prod \
                -e SPRING__DATASOURCE__URL___DB_NAME="${APP_1_DB_NAME}" \
                -e SPRING_DATASOURCE_USERNAME=team11 \
                -e SPRING_DATASOURCE_PASSWORD="${PASSWORD_1}" \
                -e REDIS_HOST=redis_1 \
                -e REDIS_PORT=6379 \
                -e REDIS_PASSWORD="${PASSWORD_1}" \
                -e RABBITMQ_HOST=rabbitmq_1 \
                -e RABBITMQ_PORT=5672 \
                -e RABBITMQ_USERNAME=admin \
                -e RABBITMQ_PASSWORD="${PASSWORD_1}" \
                -e RABBITMQ_STOMP_PORT=61613 \
                "${IMAGE}"

              # ---------------------------------------------------------
              # 5) Ìó¨Ïä§Ï≤¥ÌÅ¨ (/actuator/health 200 OKÍπåÏßÄ ÎåÄÍ∏∞)
              # ---------------------------------------------------------
              echo "‚è± health-check: ${GREEN}"
              TIMEOUT=120
              INTERVAL=3
              ELAPSED=0
              sleep 8  # Ï¥àÍ∏∞ Î∂ÄÌåÖ Ïó¨Ïú†

              while (( ELAPSED < TIMEOUT )); do
                CODE=$(docker exec "${GREEN}" curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:${PORT_IN}/actuator/health" || echo 000)
                [[ "${CODE}" == "200" ]] && { echo "‚úÖ ${GREEN} healthy"; break; }
                sleep "${INTERVAL}"
                ELAPSED=$((ELAPSED + INTERVAL))
              done
              [[ "${CODE:-000}" == "200" ]] || { echo "‚ùå ${GREEN} health failed"; docker logs --tail=200 "${GREEN}" || true; docker rm -f "${GREEN}" || true; exit 1; }

              # ---------------------------------------------------------
              # 6) ÏóÖÏä§Ìä∏Î¶º Ï†ÑÌôò (forward_host/forward_portÎßå ÏóÖÎç∞Ïù¥Ìä∏)
              # ---------------------------------------------------------
              NEW_CFG=$(jq -n --arg host "${GREEN}" --argjson port ${PORT_IN} '{forward_host:$host, forward_port:$port}')
              curl -s -X PUT "http://127.0.0.1:81/api/nginx/proxy-hosts/${PROXY_ID}" \
                -H "Authorization: Bearer ${TOKEN}" \
                -H "Content-Type: application/json" \
                -d "${NEW_CFG}" >/dev/null
              echo "üîÅ switch upstream ‚Üí ${GREEN}:${PORT_IN}"

              # ---------------------------------------------------------
              # 7) Ïù¥Ï†Ñ blue Ï¢ÖÎ£å(ÏµúÏ¥à Î∞∞Ìè¨Î©¥ ÏÉùÎûµ)
              # ---------------------------------------------------------
              if [[ "${BLUE}" != "none" ]]; then
                docker stop "${BLUE}" >/dev/null 2>&1 || true
                docker rm "${BLUE}" >/dev/null 2>&1 || true
                echo "üßπ removed old blue: ${BLUE}"
              fi

              # ---------------------------------------------------------
              # 8) Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨(ÌòÑÏû¨ ÌÉúÍ∑∏/ latest Ï†úÏô∏) - Í≤∞Í≥º ÏóÜÏùåÎèÑ Ïò§Î•ò ÏïÑÎãò
              #     - pipefailÍ≥º grepÏùò Ï¢ÖÎ£åÏΩîÎìú(1)Î•º Í≥†Î†§Ìï¥ Î∏îÎ°ù Ï†ÑÏ≤¥Ïóê || true Ï†ÅÏö©
              # ---------------------------------------------------------
              {
                docker images --format '{{.Repository}}:{{.Tag}}' \
                  | grep -F "ghcr.io/${OWNER_LC}/${IMAGE_REPOSITORY}:" \
                  | grep -v -F ":${IMAGE_TAG}" \
                  | grep -v -F ":latest" \
                  | xargs -r docker rmi
              } || true

              echo "üèÅ Blue/Green switch complete. now blue = ${GREEN}"
